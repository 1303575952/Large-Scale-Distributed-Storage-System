# 第2章 单机存储系统

*单机存储引擎就是哈希表、B树等数据结构在机械磁盘、SSD等持久化介质上的实现。单机存储系统就是单机存储引擎的一种封装，对外提供文件、键值、表格或者关系模型。
单机存储系统的理论来源于关系数据库。数据库将一个或多个操作组成一组，称作事务，事务具有ACID特性。*

## 2.1 硬件基础

*摩尔定律：每18个月计算机等IT产品的性能会翻一番；或者说相同性能的计算机等IT产品，每18个月价钱会降一半。*

### 2.1.1 CPU架构

从单核单个到多核多个；SMP架构到NUMA架构。

### 2.1.2 IO总线

存储系统的性能瓶颈一般在于IO。

### 2.1.3 网络拓扑

传统的数据中心网络拓扑。三层：接入层（Edge）、汇聚层（Aggregation）、核心层（Core）。

Google于2018年提出扁平化拓扑结构，即三级CLOS网络。

### 2.1.4 性能参数

SSD盘、SAS盘、SATA盘差异。

### 2.1.5 存储层次架构

存储系统的性能主要包括两个维度：吞吐量以及访问延时。保证访问延时的基础上，通过最低成本实现尽可能高的吞吐量。

热数据存储到SSD中，冷数据存储到磁盘中。

## 2.2 单机存储系统

*哈希存储引擎（增、删、改、随机读，不支持顺序扫描）、B树存储引擎（增、删、读、改，支持顺序扫描）、LSM树存储引擎（增、删、读、改，支持顺序扫描）。*

### 2.2.1 哈希存储引擎

*Bitcask是一个基于哈希表结构的键值存储系统，它仅支持追加操作，即所有的写操作只追加而不修改老的数据。该系统中，每个文件有一定的大小限制，当文件达到相应的大小时，就会产生一个新的文件，老的文件只读不写。任意时刻，只有一个文件是可写的，用于数据追加，称为活跃文件。*

![Bitcask文件结构](chapter2-pic/图2.2.1-Bitcask文件结构.png)

1. 数据结构

如图所示Bitcask数据文件是一条一条写入的写入操作，每一条记录的数据项分别为主键（key）、value内容（value）、主键长度（key_sz）、value长度（value_sz）、时间戳（timestamp）以及crc校验值。

![Bitcask每条数据数据结构](chapter2-pic/图2.2.1-Bitcask每条数据数据结构.png)

哈希表结构中每一项包含了三个用于定位数据的信息，分别是文件编号（file_id），value在文件中的位置（value_pos），value长度（value_sz）。

通过读取file_id对应文件的value_pos开始的value_sz个字节，就得到了最终的value值。

写入文件时首先将Key-Value记录追加到活跃数据文件的末尾，接着更新内存哈希表。因此，每个写操作总共需要进行一次顺序的磁盘写入和一次内存操作。

![Bitcask哈希表每条记录结构](chapter2-pic/图2.2.1-Bitcask哈希表每条记录结构.png)

2. 定期合并

Bitcask系统中的记录删除或更新后，原来的记录成为垃圾数据。如果这些数据一直保存下去，文件会无限膨胀下去，为了解决这个问题，Bitcask需要定期执行合并操作实现垃圾回收。

所谓合并操作，即将所有老数据文件中的数据扫描一遍并生成新的数据文件，这里的合并其实就是对同一个key的多个操作以只保留最新一个的原则进行删除，每次合并后，新生成的数据文件就不再有冗余数据了。

3. 快速恢复

Bitcask系统中的哈希索引存储在内存中，如果不做额外的工作，服务器断电重启重建哈希表需要扫描一遍数据文件，如果数据文件很大，这是一个非常耗时的过程。Bitcask通过索引文件来提高重建哈希表的速度。

索引文件就是将内存中的哈希索引表转储到磁盘上生成的结果文件。Bitcask对老数据文件进行合并操作时，会产生新的数据文件，这个过程中还会产生一个索引文件，这个索引文件记录每一条记录的哈希索引信息。
