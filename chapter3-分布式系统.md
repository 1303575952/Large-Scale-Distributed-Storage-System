# 第3章 分布式系统

*分布式系统涉及数据分布、复制、一致性、容错及分布式协议。*

## 3.1 基本概念

### 3.1.1 异常

*大规模分布式存储系统的一个核心问题在于自动容错。然而，服务器节点是不可靠的，网络也是不可靠的。*

1. 异常类型

(1) 服务器宕机

引发服务器宕机的原因可能是内存错误、服务器停电。

服务器重启节点后，节点将失去所有的内存信息。因此，设计存储系统时需要考虑如何通过读取持久化介质（如机械硬盘，固态硬盘）中的数据来恢复内存信息，从而恢复到宕机前的某个一致的状态。

(2) 网络异常

引发网络异常的原因可能是消息丢失、消息乱序（如采用UDP通信）或者网络包数据错误。考虑“网络分区”是一种特殊的异常。

设计容错系统的一个基本原则是：网络永远是不可靠的，任何一个消息只有收到对方的回复后才可认为发送成功，系统设计时总是假设网络将会出现异常并采用相应的处理措施。

(3) 磁盘故障

磁盘故障分为两种情况：磁盘损坏和磁盘数据错误。磁盘损坏时，将会丢失存储在上面的数据，，因而，分布式存储系统需要考虑将数据存储到多台服务器，即使其中一台服务器磁盘出现故障，也能从其他服务器上恢复数据。对于磁盘数据错误，往往可以采用校验和（checksum）机制解决，这样的机制既可以在操作系统层面实现，又可以在上层的分布式存储系统层面实现。

2. “超时”

由于网络异常的存在，分布式存储系统中请求结果存在“三态”的概念。如果某个节点向另一个节点发起RPC，这个RPC执行的结果有三种状态：“成功”、“失败”、“超时”（未知状态），也称为分布式存储系统的三态。

![RPC执行成功但超时](chapter3-pic/图3.1.1-RPC执行成功但超时.png)

一个通俗的例子：ATM取款时ATM机有时会提示：“无法打印凭条，是否继续取款？”。这是因为ATM机和银行服务器端通信，二者之间的网络可能出现故障，此时ATM机发往银行服务器端的RPC请求如果发生超时，ATM机无法确定RPC请求成功还是失败。正常情况下，ATM机会打印凭条，用于后续和银行服务器端对账。

当出现超时状态时，只能通过不断读取之前操作的状态来验证RPC操作是否成功。当然，设计分布式存储系统时可以将操作设计为“幂等”的，也就是说，操作执行一次与执行多次的结果相同，例如，覆盖写就是一种常见的幂等操作。如果采用这种设计，当出现失败和超时时，都可以采用相同的处理方式，即一直重试直到成功。

### 3.1.2 一致性

由于异常的存在，分布式存储系统设计时往往将数据冗余存储多份，当一个节点故障时，可以从其他副本读到数据。副本是分布式存储系统容错技术的唯一手段。由于多个副本的存在，如何保证副本之间的一致性是整个分布式系统的理论核心。

可以从两个角度理解一致性：第一个角度是用户，或者说是客户端，即客户端读写操作是否符合某种特性；第二个角度是存储系统，即存储系统的多个副本之间是否一致，更新的顺序是否相同，等等。

场景：

* 存储系统：存储系统理解为一个黑盒子，可提供可用性和持久性的保证。
* 客户端A：客户端A主要实现从存储系统write和read操作。
* 客户端B和客户端C：客户端B和C独立于A，并且B和C也是相互独立的，它们同时也实现对存储系统的write和read操作。

从客户端角度看，一致性包含如下三种情况：

**强一致性：** 假如A先写入了一个值到存储系统，存储系统保证后续A、B、C的读取操作都将返回最新值。

**弱一致性：** 假如A先写入了一个值到存储系统，存储系统不能保证后续A、B、C的读取操作是否能够读取到最新值。

**最终一致性：** 最终一致性是弱一致性的特例。假如A首先写入一个值到存储系统，存储系统保证如果后续没有写操作更新同样的值，A、B、C的读取操作最终都会读取A写入的最新值。最终一致性有一个不一致窗口的概念，它特质从A写入值，到最后A、B、C读取到最新值的这段时间。不一致窗口的大小依赖于以下几个因素：交互延迟、系统的负载，以及复制协议要求同步的副本数。

最终一致性描述比较粗略，其他常见的变体如下：

**读写（read-your-writes）一致性：** 如果客户端A写入了最新的值，那么A的后续操作都会读到最新值。但是其他用户（比如B或者C）可以要过一会儿才能看到。

**会话（session）一致性：** 要求客户端和存储系统交互的整个会话期间保证读写一致性。如果原有会话因为某种原因实效而创建新的会话，原有会话和新会话之间的操作不保证读写一致性。

**单调读（monotonic read）一致性：** 如果客户端A已经读到了对象的某个值，那么后续操作将不会读取到更早的值。

**单调写（monotonic write）一致性：** 客户端A的写操作按顺序完成，这就意味着，对于同一个客户端的操作，存储系统的多个副本需要按照与客户端相同的顺序完成。

从存储系统的角度看，一致性主要包括以下几个方面：

**副本一致性：** 存储系统的多个副本之间的数据是否一致，不一致的时间窗口等。

**更新顺序一致性：** 存储系统的多个副本之间是否按照相同的顺序执行更新操作。

一般来说，存储系统可以支持强一致性，也可以为了性能考虑最终一致性。

### 3.1.3 衡量指标

（1） 性能

常见的性能指标有:系统的吞吐能力以及系统的响应时间。其中，系统的吞吐能力指系统在某一时间可以处理的请求总数，通常用每秒处理的读操作数（QPS，Query Per Second）或者写操作数（TPS，Transaction Per Second）来衡量；系统的相应延迟，指从某个请求发出到接收到返回结果消耗的时间，通常用平均延时或者99.9%以上请求的最大延时来衡量。这两个指标往往是矛盾的，追求高吞吐量的系统，往往很难做到低延迟；追求低延迟的系统，吞吐量也会受到限制。因此，设计系统时需要权衡这两个指标。

（2） 可用性

系统的可用性（availability）是指系统在面对各种异常时可以提供正常服务的能力。系统的可用性可以用系统停服务的时间与正常服务的时间的比例来衡量。

（3） 一致性

3.1.2节说明了系统的一致性。一般来说，越是强的一致性模型，用户使用起来越简单。

>笔者认为，如果系统部署在一个数据中心，只要系统设计合理，在保证强一致性的前提下，不会对性能和可用性造成太大影响。后文中笔者在Alibaba参与开发的OceanBase系统以及Google的分布式存储系统都倾向强一致性。

（4） 可扩展性

系统的可扩展性指分布式存储系统通过扩展集群服务器规模来提高系统存储容量、计算量和性能的能力。

随着业务的发展，对底层存储系统的性能需求不断增加，比较好的方式就是通过自动增加服务器提高系统的能力。理想的分布式存储系统实现了“线性可扩展”，也就是说，随着集群规模的增加，系统的整体性能与服务器数量呈线性关系。

## 3.2 性能分析

*性能分析就是需要找出可能出现的资源瓶颈。*

**1. 生成一张有30张缩略图（假设图片原始大小256KB）的页面需要多长时间？**

**方案1：** 顺序操作，每次先从磁盘中读取图片，再执行生成缩略图操作，执行时间为：30*10ms（磁盘随机读取时间）+30*256K/30MB/s（假设缩略图生成速度为30MB/s）=560ms

**方案2：** 并行操作，一次性发送30个请求，每个请求读取一张图片并生成缩略图，执行时间为：10ms+256K/300MB/s=18ms

这里其他因素暂不考虑。

**2. 1GB的4字节整数，执行一次快速排序需要多少时间？**

Google的Jeff Dean提出了一种排序性能分析方法：排序时间=比较时间（分支预测错误）+内存访问时间。快速排序过程中会发生大量的分支预测错误，比较次数为
