# 第3章 分布式系统

*分布式系统涉及数据分布、复制、一致性、容错及分布式协议。*

## 3.1 基本概念

### 3.1.1 异常

*大规模分布式存储系统的一个核心问题在于自动容错。然而，服务器节点是不可靠的，网络也是不可靠的。*

1. 异常类型

(1) 服务器宕机

引发服务器宕机的原因可能是内存错误、服务器停电。

服务器重启节点后，节点将失去所有的内存信息。因此，设计存储系统时需要考虑如何通过读取持久化介质（如机械硬盘，固态硬盘）中的数据来恢复内存信息，从而恢复到宕机前的某个一致的状态。

(2) 网络异常

引发网络异常的原因可能是消息丢失、消息乱序（如采用UDP通信）或者网络包数据错误。考虑“网络分区”是一种特殊的异常。

设计容错系统的一个基本原则是：网络永远是不可靠的，任何一个消息只有收到对方的回复后才可认为发送成功，系统设计时总是假设网络将会出现异常并采用相应的处理措施。

(3) 磁盘故障

磁盘故障分为两种情况：磁盘损坏和磁盘数据错误。磁盘损坏时，将会丢失存储在上面的数据，，因而，分布式存储系统需要考虑将数据存储到多台服务器，即使其中一台服务器磁盘出现故障，也能从其他服务器上恢复数据。对于磁盘数据错误，往往可以采用校验和（checksum）机制解决，这样的机制既可以在操作系统层面实现，又可以在上层的分布式存储系统层面实现。

2. “超时”

由于网络异常的存在，分布式存储系统中请求结果存在“三态”的概念。如果某个节点向另一个节点发起RPC，这个RPC执行的结果有三种状态：“成功”、“失败”、“超时”（未知状态），也称为分布式存储系统的三态。

![RPC执行成功但超时](chapter3-pic/图3.1.1-RPC执行成功但超时.png)

一个通俗的例子：ATM取款时ATM机有时会提示：“无法打印凭条，是否继续取款？”。这是因为ATM机和银行服务器端通信，二者之间的网络可能出现故障，此时ATM机发往银行服务器端的RPC请求如果发生超时，ATM机无法确定RPC请求成功还是失败。正常情况下，ATM机会打印凭条，用于后续和银行服务器端对账。

当出现超时状态时，只能通过不断读取之前操作的状态来验证RPC操作是否成功。当然，设计分布式存储系统时可以将操作设计为“幂等”的，也就是说，操作执行一次与执行多次的结果相同，例如，覆盖写就是一种常见的幂等操作。如果采用这种设计，当出现失败和超时时，都可以采用相同的处理方式，即一直重试直到成功。

### 3.1.2 一致性

由于异常的存在，分布式存储系统设计时往往将数据冗余存储多份，当一个节点故障时，可以从其他副本读到数据。副本是分布式存储系统容错技术的唯一手段。由于多个副本的存在，如何保证副本之间的一致性是整个分布式系统的理论核心。

可以从两个角度理解一致性：第一个角度是用户，或者说是客户端，即客户端读写操作是否符合某种特性；第二个角度是存储系统，即存储系统的多个副本之间是否一致，更新的顺序是否相同，等等。

场景：

* 存储系统：存储系统理解为一个黑盒子，可提供可用性和持久性的保证。
* 客户端A：客户端A主要实现从存储系统write和read操作。
* 客户端B和客户端C：客户端B和C独立于A，并且B和C也是相互独立的，它们同时也实现对存储系统的write和read操作。

从客户端角度看，一致性包含如下三种情况：

**强一致性：** 假如A先写入了一个值到存储系统，存储系统保证后续A、B、C的读取操作都将返回最新值。
**弱一致性：** 假如A先写入了一个值到存储系统，存储系统不能保证后续A、B、C的读取操作是否能够读取到最新值。
**最终一致性：** 最终一致性是弱一致性的特例。
